ext4: Fix eCryptfs key packet parsing

From: Michael Halcrow <mhalcrow@google.com>

Note that the eCryptfs key packet code is temporary. We're going to be
changing the format of the key material passed to ext4 via the
keyring.

That said, this temporary code is broken because I copied the wrong
code from eCryptfs (d'oh!), so this patch fixes it. The bits just so
happened to be twiddled in the right way to make it past the type and
flag checks.

(Ildar, sorry you had to bang your head against this issue today...)

Signed-off-by: Ildar Muslukhov <ildarm@google.com>
Signed-off-by: Michael Halcrow <mhalcrow@google.com>
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
---
 fs/ext4/crypto.c | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/fs/ext4/crypto.c b/fs/ext4/crypto.c
index 0a4d9fb..d655a64 100644
--- a/fs/ext4/crypto.c
+++ b/fs/ext4/crypto.c
@@ -563,13 +563,11 @@ static int ext4_get_wrapping_key_from_keyring(
 	const char sig[EXT4_WRAPPING_KEY_SIG_NULL_TERMINATED_SIZE])
 {
 	struct key *create_key;
-	struct encrypted_key_payload *payload;
 	struct ecryptfs_auth_tok *auth_tok;
 
 	create_key = request_key(&key_type_user, sig, NULL);
 	if (WARN_ON_ONCE(IS_ERR(create_key)))
 		return -ENOENT;
-	payload = (struct encrypted_key_payload *)create_key->payload.data;
 	if (WARN_ON_ONCE(create_key->datalen !=
 			 sizeof(struct ecryptfs_auth_tok))) {
 		printk(KERN_ERR
@@ -578,7 +576,15 @@ static int ext4_get_wrapping_key_from_keyring(
 		       sizeof(struct ecryptfs_auth_tok));
 		return -EINVAL;
 	}
-	auth_tok = (struct ecryptfs_auth_tok *)(&(payload)->payload_data);
+	if (create_key->type == &key_type_encrypted) {
+		auth_tok = (struct ecryptfs_auth_tok *)
+			(&((struct encrypted_key_payload *)
+			   create_key->payload.data)->payload_data);
+	} else {
+		auth_tok = (struct ecryptfs_auth_tok *)
+			(&((struct user_key_payload *)
+			   create_key->payload.data)->data);
+	}
 	if (WARN_ON_ONCE(!(auth_tok->token.password.flags &
 			   ECRYPTFS_SESSION_KEY_ENCRYPTION_KEY_SET))) {
 		printk(KERN_ERR
-- 
2.1.0.rc2.206.gedb03e5


